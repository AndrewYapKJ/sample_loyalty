@inherits LayoutComponentBase
@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<MainLayout> Logger

<div class="min-h-screen bg-gray-50 text-gray-900">
    <!-- Topbar -->
    <header class="fixed top-0 left-0 right-0 h-16 bg-white shadow flex items-center px-4 z-50">
        <button class="p-2 mr-3 rounded hover:bg-gray-100" @onclick="ToggleSidebar">â˜°</button>
        <div class="font-semibold text-lg">Loyalty Admin</div>
        <div class="flex-1"></div>
        <button class="p-2 rounded hover:bg-gray-100" @onclick="Logout">â‹</button>
    </header>

    <div class="pt-16 flex">
        <!-- Main content -->
        <main class="flex-1 p-6">
            @Body
        </main>

        <!-- Left sidebar -->
        <aside class="@SidebarClass" style="@AsideStyle">
            <nav class="py-4">
                <a class="block px-4 py-2 hover:bg-gray-100" href="/dashboard">ğŸ  <span
                        class="ml-2">Dashboard</span></a>
                <a class="block px-4 py-2 hover:bg-gray-100" href="/appointments">ğŸ“… <span
                        class="ml-2">Appointments</span></a>
                <a class="block px-4 py-2 hover:bg-gray-100" href="/customers">ğŸ‘¥ <span
                        class="ml-2">Customers</span></a>
                <a class="block px-4 py-2 hover:bg-gray-100" href="/transactions">ğŸ§¾ <span
                        class="ml-2">Transactions</span></a>
            </nav>
        </aside>
    </div>
</div>

@code {
    private bool sidebarExpanded = true;
    private string currentTheme = "light";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var savedTheme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "theme");
                if (!string.IsNullOrEmpty(savedTheme)) currentTheme = savedTheme;
            }
            catch (Exception ex)
            {
                Logger.LogDebug(ex, "Failed to read theme");
            }
        }
    }

    void ToggleSidebar()
    {
        sidebarExpanded = !sidebarExpanded;
        StateHasChanged();
    }

    async Task ToggleTheme()
    {
        currentTheme = currentTheme == "light" ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("changeTheme", currentTheme);
    }

    async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "jwtToken");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "refreshToken");
        Navigation.NavigateTo("/", true);
    }

    private string ThemeIcon => currentTheme == "light" ? "ğŸŒ™" : "â˜€";

    private string AsideStyle => $"width:{(sidebarExpanded ? "260px" : "72px")};";
    private string SidebarClass => $"bg-white border-r h-screen fixed left-0 top-16 shadow-lg transition-all duration-200{(sidebarExpanded ? "" : " hidden")}";
}