@using loyalty_sfotware.Services
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject ILogger<AuthenticatedPage> Logger
@rendermode InteractiveServer

@if (!isAuthenticated && !hasCheckedAuth)
{
   <div class="d-flex justify-content-center align-items-center vh-100">
      <div class="spinner-border text-success" role="status">
         <span class="visually-hidden">Authenticating...</span>
      </div>
   </div>
}
else if (isAuthenticated)
{
   @ChildContent
}

@code {
   [Parameter] public RenderFragment? ChildContent { get; set; }

   private bool isAuthenticated = false;
   private bool hasCheckedAuth = false;

   protected override async Task OnAfterRenderAsync(bool firstRender)
   {
      if (firstRender)
      {
         await CheckAuthentication();
         hasCheckedAuth = true;
         StateHasChanged();
      }
   }

   private async Task CheckAuthenticationPreRender()
   {
      // Removed - will handle authentication in OnAfterRenderAsync only
   }

   private async Task CheckAuthentication()
   {
      try
      {
         var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "jwtToken");

         if (string.IsNullOrEmpty(token))
         {
            // No token, redirect immediately
            Navigation.NavigateTo("/", true);
            return;
         }

         isAuthenticated = await AuthService.ValidateTokenAsync(token);

         if (!isAuthenticated)
         {
            // Attempt an automatic refresh using the stored refresh token before forcing a redirect
            try
            {
               var refreshToken = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "refreshToken");

               if (!string.IsNullOrEmpty(refreshToken))
               {
                  var refreshResult = await AuthService.RefreshTokenAsync(refreshToken);
                  if (refreshResult != null && refreshResult.Success && !string.IsNullOrEmpty(refreshResult.AccessToken))
                  {
                     // Persist new tokens and mark authenticated
                     await JSRuntime.InvokeVoidAsync("localStorage.setItem", "jwtToken", refreshResult.AccessToken);
                     if (!string.IsNullOrEmpty(refreshResult.RefreshToken))
                     {
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "refreshToken", refreshResult.RefreshToken);
                     }

                     isAuthenticated = true;
                     return;
                  }
               }
            }
            catch (Exception ex)
            {
               Logger.LogWarning(ex, "Refresh token attempt failed");
            }

            Navigation.NavigateTo("/", true);
         }
      }
      catch (Exception ex)
      {
         Logger.LogError(ex, "Authentication check failed");
         Navigation.NavigateTo("/", true);
      }
   }
}