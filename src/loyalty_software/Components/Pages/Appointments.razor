
@page "/appointments"
@using loyalty_sfotware.Services
@using gussmann_loyalty_program.Models
@inject IAuthService AuthService
@inherits loyalty_sfotware.Components.Auth.JwtGuardComponent
@rendermode InteractiveServer

<PageTitle>Appointments - Gussmann Loyalty Program</PageTitle>

@if (!isAuthenticated)
{
   <!-- redirecting to login -->
}
else
{
   <div class="space-y-4">
      <div class="flex items-center justify-between">
         <div>
            <h1 class="text-2xl font-semibold">Appointments</h1>
            <p class="text-sm text-gray-500">Manage customer appointments and bookings</p>
         </div>
         <div>
            <button class="px-4 py-2 bg-green-700 text-white rounded" @onclick="ShowCreate">Create New Appointment</button>
         </div>
      </div>

      <div class="bg-white shadow rounded overflow-auto">
         <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
               <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date & Time</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Store</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
               </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
               @foreach (var appt in appointments)
               {
                  <tr>
                     <td class="px-6 py-4 whitespace-nowrap">@appt.AppointmentTime.ToString("dd/MM/yyyy HH:mm")</td>
                     <td class="px-6 py-4 whitespace-nowrap">@appt.UserId</td>
                     <td class="px-6 py-4 whitespace-nowrap">@appt.StoreId</td>
                     <td class="px-6 py-4 whitespace-nowrap">@appt.ServiceId</td>
                     <td class="px-6 py-4 whitespace-nowrap">
                        <span
                           class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @GetStatusClass(appt.Status)">@appt.Status</span>
                     </td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-3"
                           @onclick="@(() => OnEditAppointment(appt))">Edit</button>
                        <button class="text-red-600 hover:text-red-900"
                           @onclick="@(() => OnDeleteAppointment(appt))">Delete</button>
                     </td>
                  </tr>
               }
            </tbody>
         </table>
      </div>
   </div>

   @if (showCreateModal)
   {
      <div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
         <div class="bg-white rounded-lg p-6 w-full max-w-lg">
            <CreateAppointmentDialog Appointment="editingAppointment" OnSaved="OnDialogSaved" OnCancel="CloseDialog" />
         </div>
      </div>
   }
}

@code {
   private bool isAuthenticated = false;
   private List<Appointment> appointments = new();
   private bool showCreateModal = false;
   private Appointment editingAppointment = new();

   protected override async Task OnAfterRenderAsync(bool firstRender)
   {
      if (firstRender)
      {
         await CheckAuthentication();
         StateHasChanged();
      }
   }

   private async Task CheckAuthentication()
   {
      try
      {
         var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "jwtToken");
         if (string.IsNullOrEmpty(token))
         {
            Navigation.NavigateTo("/", true);
            return;
         }
         isAuthenticated = await AuthService.ValidateTokenAsync(token);
         if (!isAuthenticated)
         {
            Navigation.NavigateTo("/", true);
         }
         else
         {
            await LoadAppointments();
         }
      }
      catch (Exception ex)
      {
         Console.WriteLine($"Authentication error: {ex.Message}");
         Navigation.NavigateTo("/", true);
      }
   }

   private async Task LoadAppointments()
   {
      // Mock data - replace with actual API call
      appointments = new List<Appointment>
{
new Appointment { Id = Guid.NewGuid().ToString(), UserId = "customer-1", StoreId = "store-1", ServiceId = "service-1",
AppointmentTime = DateTime.Now.AddDays(2), Status = "Scheduled" },
new Appointment { Id = Guid.NewGuid().ToString(), UserId = "customer-2", StoreId = "store-1", ServiceId = "service-2",
AppointmentTime = DateTime.Now.AddDays(3), Status = "Scheduled" }
};
      await Task.CompletedTask;
   }

   private void ShowCreate()
   {
      editingAppointment = new Appointment { AppointmentTime = DateTime.Now.AddDays(1), Status = "Scheduled" };
      showCreateModal = true;
   }

   private async Task OnDialogSaved(Appointment appt)
   {
      // if exists update, else add
      var existing = appointments.FirstOrDefault(a => a.Id == appt.Id);
      if (existing != null)
      {
         var idx = appointments.IndexOf(existing);
         appointments[idx] = appt;
      }
      else
      {
         appointments.Add(appt);
      }
      showCreateModal = false;
      await InvokeAsync(StateHasChanged);
   }

   private void CloseDialog()
   {
      showCreateModal = false;
   }

   private void OnEditAppointment(Appointment appointment)
   {
      EditAppointment(appointment);
   }

   private async Task OnDeleteAppointment(Appointment appointment)
   {
      await DeleteAppointment(appointment);
   }

   private void EditAppointment(Appointment appointment)
   {
      editingAppointment = new Appointment
      {
         Id = appointment.Id,
         UserId = appointment.UserId,
         StoreId = appointment.StoreId,
         ServiceId = appointment.ServiceId,
         AppointmentTime = appointment.AppointmentTime,
         Status = appointment.Status
      };
      showCreateModal = true;
   }

   private async Task DeleteAppointment(Appointment appointment)
   {
      var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this appointment?");
      if (confirmed)
      {
         appointments.Remove(appointment);
      }
   }

   private string GetStatusClass(string status)
   {
      return status == "Scheduled" ? "bg-green-100 text-green-800" : status == "Cancelled" ? "bg-red-100 text-red-800" :
      "bg-blue-100 text-blue-800";
   }
}